---
import { ViewTransitions } from 'astro:transitions';
import Analytics from '@vercel/analytics/astro';
import SpeedInsights from '@vercel/speed-insights/astro';

interface Props {
  title: string;
  description?: string;
  backLink?: string;
  publishDate?: Date;
  articleType?: 'BlogPosting' | 'Article';
}

const { title, description, backLink, publishDate, articleType } = Astro.props;
const currentPath = Astro.url.pathname;
const isBlogPost = currentPath !== '/' && currentPath !== '/thoughts' && currentPath !== '/thoughts/' && currentPath !== '/about' && currentPath !== '/about/' && currentPath !== '/projects' && currentPath !== '/projects/' && currentPath !== '/experiments' && currentPath !== '/experiments/';
const isExperiments = currentPath === '/experiments' || currentPath === '/experiments/';
const isProjects = currentPath === '/projects' || currentPath === '/projects/';
const isAbout = currentPath === '/about' || currentPath === '/about/';
const isHome = currentPath === '/' || currentPath === '';

// Default OG values
const ogTitle = title;
const ogDescription = description || "Broderick Cotter's personal website - engineer, polymath, and athlete sharing projects, thoughts, and experiments.";
const ogImage = `${Astro.site}og-image.png?title=${encodeURIComponent(title)}${description ? `&description=${encodeURIComponent(description)}` : ''}`;
const ogUrl = `${Astro.site}${currentPath.slice(1)}`;
const canonicalUrl = ogUrl.endsWith('/') ? ogUrl.slice(0, -1) : ogUrl;

// JSON-LD Schema
const personSchema = {
  "@context": "https://schema.org",
  "@type": "Person",
  "name": "Broderick Cotter",
  "url": "https://brody.gg",
  "sameAs": [
    "https://www.linkedin.com/in/broderickc/",
    "https://github.com/M3kko",
    "https://x.com/Brodylame",
    "https://www.instagram.com/brody_lane/"
  ],
  "jobTitle": "Engineer",
  "description": "Polymath, Engineer, Athlete"
};

const websiteSchema = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": "Broderick Cotter",
  "alternateName": "Brody.gg",
  "url": "https://brody.gg"
};

const articleSchema = publishDate && articleType ? {
  "@context": "https://schema.org",
  "@type": articleType,
  "headline": title.replace(' - Broderick Cotter', ''),
  "description": description || ogDescription,
  "author": {
    "@type": "Person",
    "name": "Broderick Cotter",
    "url": "https://brody.gg"
  },
  "publisher": {
    "@type": "Person",
    "name": "Broderick Cotter",
    "url": "https://brody.gg"
  },
  "datePublished": publishDate.toISOString(),
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": canonicalUrl
  }
} : null;
---

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{title}</title>
    <meta name="description" content={ogDescription} />
    <meta name="author" content="Broderick Cotter" />
    <link rel="canonical" href={canonicalUrl} />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content={ogUrl}>
    <meta property="og:title" content={ogTitle}>
    <meta property="og:description" content={ogDescription}>
    <meta property="og:image" content={ogImage}>
    <meta property="og:site_name" content="Broderick Cotter" />
    <meta property="og:locale" content="en_US" />

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content={ogUrl}>
    <meta property="twitter:title" content={ogTitle}>
    <meta property="twitter:description" content={ogDescription}>
    <meta property="twitter:image" content={ogImage}>
    <meta property="twitter:creator" content="@Brodylame" />

    <!-- JSON-LD Structured Data -->
    <script type="application/ld+json" set:html={JSON.stringify(personSchema)} />
    {isHome && <script type="application/ld+json" set:html={JSON.stringify(websiteSchema)} />}
    {articleSchema && <script type="application/ld+json" set:html={JSON.stringify(articleSchema)} />}

    <link rel="icon" type="image/png" href="/assets/svg/favicon.png">
    <link rel="preload" href="/assets/svg/fonts/OCR-B.ttf" as="font" type="font/ttf" crossorigin>
    <link rel="preload" href="/assets/svg/fonts/instrumentserif-italic.ttf" as="font" type="font/ttf" crossorigin>
    <link rel="stylesheet" href="/styles.css">
    <ViewTransitions />
    <script is:inline>
        // Prevent flash: set theme before page renders
        (function() {
            const saved = localStorage.getItem('theme');
            if (saved === 'dark' || saved === 'light') {
                document.documentElement.setAttribute('data-theme', saved);
            } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        })();
    </script>
</head>
<body class={`${isBlogPost ? 'blog-post' : ''} ${isExperiments ? 'experiments' : ''} ${isProjects ? 'projects' : ''} ${isAbout ? 'about' : ''}`}>
    <a href={backLink || (isBlogPost ? '/thoughts' : '/')} class="logo">
        <img src="/assets/svg/triangle.svg" alt="Logo" width="48" height="48">
    </a>

    <button class="theme-toggle" aria-label="Toggle theme">
        <img src="/assets/svg/sun-high.svg" alt="Light mode" class="theme-icon sun" />
        <img src="/assets/svg/moon-stars.svg" alt="Dark mode" class="theme-icon moon" />
    </button>

    <slot />

    <script is:inline>
        function initThemeToggle() {
            const root = document.documentElement;
            const toggle = document.querySelector('.theme-toggle');
            const sunIcon = toggle?.querySelector('.sun');
            const moonIcon = toggle?.querySelector('.moon');

            function getSystemTheme() {
                return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            }

            function getCurrentTheme() {
                const saved = localStorage.getItem('theme');
                if (saved === 'dark' || saved === 'light') return saved;
                return getSystemTheme();
            }

            function updateIcon(theme) {
                if (sunIcon && moonIcon) {
                    // Show sun in dark mode (to switch to light), moon in light mode (to switch to dark)
                    sunIcon.style.display = theme === 'dark' ? 'block' : 'none';
                    moonIcon.style.display = theme === 'dark' ? 'none' : 'block';
                }
            }

            function setTheme(theme) {
                root.setAttribute('data-theme', theme);
                updateIcon(theme);
            }

            // Initialize theme and icon
            const initialTheme = getCurrentTheme();
            setTheme(initialTheme);

            // Toggle handler
            toggle?.addEventListener('click', () => {
                const current = root.getAttribute('data-theme') || getCurrentTheme();
                const next = current === 'dark' ? 'light' : 'dark';
                localStorage.setItem('theme', next);
                setTheme(next);
            });

            // Listen for system preference changes
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                if (!localStorage.getItem('theme')) {
                    setTheme(e.matches ? 'dark' : 'light');
                }
            });
        }

        initThemeToggle();
        document.addEventListener('astro:page-load', initThemeToggle);
    </script>
    <Analytics />
    <SpeedInsights />
</body>
</html>