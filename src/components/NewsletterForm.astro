---
interface Props {
  active?: boolean;
}

const { active = false} = Astro.props;
---

<div class="newsletter-card">
    <h3>{active ? 'This experiment is still active' : 'Like what I\'m doing?'}</h3>
    <p class="description">{active ? 'Subscribe to my newsletter to stay updated on it :)' : 'Get new experiments and updates in your inbox. Once or twice a month.'}</p>
    <form id="newsletter-form">
        <input
            type="email"
            id="email-input"
            placeholder="your@email.com"
            required
        />
        <button type="submit">Follow along</button>
    </form>
</div>

<style> 
.newsletter-card {
    background-color: rgba(0,0,0,0.03);
    border: 1px solid rgba(0,0,0,0.1);
    border-radius: 8px;
    padding: 1.5rem;
}

h3 {
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0 0 0.5rem 0;
}

.description {
    font-size: 0.875rem;
    opacity: 0.7;
    margin: 0 0 1rem 0;
    line-height: 1.5;
}

form {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

input[type="email"] {
    width: 100%;
    padding: 0.625rem;
    border: 1px solid rgba(0, 0, 0, 0.2);
    border-radius: 6px;
    font-size: 16px; /* Prevents iOS zoom on focus */
    background-color: var(--bg);
    color: var(--text);
    transition: border-color 0.2s;
}

input[type="email"]: focus {
    outline: none;
    border-color: var(--text);
}

button {
    padding: 0.625rem 1rem;
    background-color: var(--text);
    color: var(--bg);
    border: none;
    border-radius: 6px;
    font-size: 0.9rem;
    cursor: pointer;
    font-weight: 500;
    transition: opacity 0.2s;
}

button:hover {
    opacity: 0.8;
    background-color: var(--accent);
    cursor: pointer;
}

button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

</style>

<script is:inline>
    (function initNewsletterForm() {
        const form = document.getElementById('newsletter-form');
        const emailInput = document.getElementById('email-input');
        const submitBtn = form?.querySelector('button[type="submit"]');

        if (!form || !emailInput || !submitBtn) {
            // Elements not ready yet, try again soon
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initNewsletterForm);
            } else {
                setTimeout(initNewsletterForm, 100);
            }
            return;
        }

        // Prevent double initialization
        if (form.dataset.initialized) return;
        form.dataset.initialized = 'true';

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const email = emailInput.value.trim();

            if (!email) return;

            submitBtn.disabled = true;
            submitBtn.textContent = 'Subscribing...';

            try {
                const response = await fetch('/api/subscribe', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email }),
                });

                const data = await response.json();

                if (response.ok) {
                    submitBtn.textContent = data.message || 'âœ“ Subscribed!';
                    submitBtn.style.backgroundColor = 'rgba(255, 0, 0, 0.6)';
                    emailInput.value = '';
                    setTimeout(() => {
                        submitBtn.textContent = 'Subscribe';
                        submitBtn.style.backgroundColor = '';
                        submitBtn.disabled = false;
                    }, 3000);
                } else {
                    submitBtn.textContent = data.error || 'Error!';
                    submitBtn.style.backgroundColor = 'red';
                    setTimeout(() => {
                        submitBtn.textContent = 'Subscribe';
                        submitBtn.style.backgroundColor = '';
                        submitBtn.disabled = false;
                    }, 3000);
                }
            } catch (error) {
                submitBtn.textContent = 'Network error!';
                submitBtn.style.backgroundColor = 'red';
                setTimeout(() => {
                    submitBtn.textContent = 'Subscribe';
                    submitBtn.style.backgroundColor = '';
                    submitBtn.disabled = false;
                }, 3000);
            }
        });
    })();
</script>